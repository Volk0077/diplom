{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/bookings.css' %}">
{% endblock %}
{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å - –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã{% endblock %}

{% block content %}
<div class="booking-card">
    <div class="card-header">
        <h2>–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —É—Å–ª—É–≥—É</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è</p>
    </div>  
    <form method="post">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="errors">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="form-section">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥–∏</h3>
            <div class="form-group">
                {{ form.category }}
                {% if form.category.errors %}
                    <div class="errors">{{ form.category.errors }}</div>
                {% endif %}
            </div>
        </div>      

        <div class="form-section">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</h3>
            <div class="form-group">
                {{ form.service }}
                {% if form.service.errors %}
                    <div class="errors">{{ form.service.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-section">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</h3>
            <div class="form-group">
                {{ form.staff }}
                {% if form.staff.errors %}
                    <div class="errors">{{ form.staff.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-section">
            <h3>üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</h3>
            <div class="form-group">
                {{ form.appointment_date }}
                {% if form.appointment_date.errors %}
                    <div class="errors">{{ form.appointment_date.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.appointment_time }}
                {% if form.appointment_time.errors %}
                    <div class="errors">{{ form.appointment_time.errors }}</div>
                {% endif %}
            </div>
        </div>

        <button type="submit" class="btn btn-modern">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('select[name="category"]');
    const serviceSelect = document.querySelector('select[name="service"]');
    const staffSelect = document.querySelector('select[name="staff"]');

    if (categorySelect && serviceSelect && staffSelect) {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥
        function updateServices() {
            const categoryId = categorySelect.value;
            serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';
            staffSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';

            if (!categoryId) {
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            fetch(`/bookings/api/services/?category=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.name;
                        serviceSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading services:', error));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
        function updateStaff() {
            const serviceId = serviceSelect.value;
            staffSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</option>';

            if (!serviceId) {
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏
            fetch(`/bookings/api/staff/?service=${serviceId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(staff => {
                        const option = document.createElement('option');
                        option.value = staff.id;
                        option.textContent = staff.first_name;
                        staffSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading staff:', error));
        }

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        categorySelect.addEventListener('change', updateServices);
        serviceSelect.addEventListener('change', updateStaff);
    }
});
</script>
{% endblock %}
